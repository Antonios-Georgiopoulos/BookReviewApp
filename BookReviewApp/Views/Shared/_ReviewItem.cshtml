@using System.Security.Claims
@model BookReviewApp.Models.ViewModels.ReviewViewModel

<div class="review-item border-bottom pb-3 mb-3">
    <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
            <h6 class="mb-1">@Model.UserName</h6>
            <div class="d-flex align-items-center mb-2">
                @for (int i = 1; i <= 5; i++)
                {
                    <i class="fas fa-star @(i <= Model.Rating ? "text-warning" : "text-muted") me-1"></i>
                }
                <small class="text-muted ms-2">@Model.DateCreated.ToString("dd/MM/yyyy HH:mm")</small>
            </div>
        </div>

        @if (User.Identity.IsAuthenticated && User.FindFirstValue(ClaimTypes.NameIdentifier) == Model.UserId)
        {
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" asp-controller="Reviews" asp-action="Edit" asp-route-id="@Model.Id">
                            <i class="fas fa-edit"></i> Επεξεργασία
                        </a>
                    </li>
                    <li>
                        <form asp-controller="Reviews" asp-action="Delete" method="post" class="d-inline">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="bookId" value="@Model.BookId" />
                            <button type="submit" class="dropdown-item text-danger"
                                    onclick="return confirm('Είστε βέβαιος ότι θέλετε να διαγράψετε την κριτική σας;')">
                                <i class="fas fa-trash"></i> Διαγραφή
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        }
    </div>

    <p class="mb-3">@Model.Content</p>

    <!-- Voting -->
    @if (User.Identity.IsAuthenticated && User.FindFirstValue(ClaimTypes.NameIdentifier) != Model.UserId)
    {
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-sm vote-btn @(Model.UserVote == true ? "btn-success" : "btn-outline-success")"
                    data-review-id="@Model.Id" data-vote="true" data-book-id="@Model.BookId">
                <i class="fas fa-thumbs-up"></i> @Model.UpvoteCount
            </button>
            <button class="btn btn-sm vote-btn @(Model.UserVote == false ? "btn-danger" : "btn-outline-danger")"
                    data-review-id="@Model.Id" data-vote="false" data-book-id="@Model.BookId">
                <i class="fas fa-thumbs-down"></i> @Model.DownvoteCount
            </button>
            <span class="text-muted small">
                Συνολική βαθμολογία: @Model.NetVotes
            </span>
        </div>
    }
    else if (User.Identity.IsAuthenticated)
    {
        <div class="text-muted small">
            <i class="fas fa-thumbs-up text-success"></i> @Model.UpvoteCount
            <i class="fas fa-thumbs-down text-danger ms-3"></i> @Model.DownvoteCount
            <span class="ms-3">Συνολική βαθμολογία: @Model.NetVotes</span>
        </div>
    }
    else
    {
        <div class="text-muted small">
            <i class="fas fa-thumbs-up text-success"></i> @Model.UpvoteCount
            <i class="fas fa-thumbs-down text-danger ms-3"></i> @Model.DownvoteCount
            <span class="ms-3">Συνολική βαθμολογία: @Model.NetVotes</span>
            <div class="mt-2">
                <a asp-area="Identity" asp-page="/Account/Login">Συνδεθείτε</a> για να ψηφίσετε
            </div>
        </div>
    }
</div>